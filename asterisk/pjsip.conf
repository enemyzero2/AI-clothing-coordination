; ==============================================================================
; PJSIP 配置文件 (优化版)
;
; 结构说明:
; 1. 全局传输设置 (transport): 定义 Asterisk 如何监听网络连接。
; 2. 模板定义 (!): 定义可复用的基础配置，简化用户创建。
; 3. 用户配置: 为每个用户定义 endpoint, auth, aor 三个部分。
;    - Endpoint: 定义电话的能力和行为。
;    - Auth: 定义用户的认证信息 (用户名/密码)。
;    - AOR (Address of Record): 定义用户的联系地址和在线状态。
; ==============================================================================

; ========================= 1. 全局传输设置 ==========================
; 为不同的协议（UDP, TCP, TLS）定义监听方式
; 如果你的环境在NAT后面，EXTERNAL_IP变量需要被正确设置。
; 对于简单的局域网测试，可以暂时忽略或注释掉 external_*_address。

[transport-udp]
type=transport
protocol=udp
bind=0.0.0.0:5060
local_net=10.0.0.0/8                  ; 告诉 Asterisk，所有 10.x.x.x 的地址都是内网
local_net=172.16.0.0/12               ; Docker内部网络
external_media_address=10.29.206.148  ; 媒体流(语音)要通告的地址是你Windows的IP
external_signaling_address=10.29.206.148  ; 信令要通告的地址也是你Windows的IP


[transport-tcp]
type=transport
protocol=tcp
bind=0.0.0.0:5060
external_media_address=10.29.206.148
external_signaling_address=10.29.206.148

[transport-tls]
type=transport
protocol=tls
bind=0.0.0.0:5061
cert_file=/etc/asterisk/certs/asterisk.pem
ca_list_file=/etc/asterisk/certs/ca.crt
external_media_address=10.29.206.148
external_signaling_address=10.29.206.148


; ========================= 2. 模板定义 ============================
; 这是一个基础的 Endpoint 模板，定义了所有用户的通用设置
[endpoint_template](!)
type=endpoint
context=internal          ; 所有用户拨号都进入 'internal' 拨号计划
disallow=all              ; 先禁用所有编码
allow=ulaw                ; 允许 G.711 u-law (北美常用)
allow=alaw                ; 允许 G.711 a-law (欧洲/其他地区常用)
allow=gsm                 ; 允许 GSM 编码，节省带宽
direct_media=no           ; 所有媒体流都经过 Asterisk (便于录音等操作)
dtmf_mode=rfc4733         ; DTMF (按键) 信号的传输方式
send_rpid=yes             ; 发送远端ID信息
call_group=1              ; 默认的呼叫组
pickup_group=1            ; 默认的代接组
rtp_symmetric=yes         ; 启用对称RTP
rewrite_contact=yes       ; 重写联系人字段


; 这是一个基础的 AOR 模板，定义了用户地址的通用设置
[aor_template](!)
type=aor
max_contacts=1            ; 每个用户只允许一个设备同时注册
qualify_frequency=60      ; 每60秒检查一次设备是否在线


; ========================= 3. 用户配置 ============================
; 每个用户都由三个同名的部分组成: endpoint, auth, aor
; 这种结构清晰明了，是 PJSIP 的推荐实践。

; --------------- 用户 101 (原 user1) ---------------
[101](endpoint_template)      ; 从模板继承，并定义 Endpoint
callerid="用户1" <101>      ; 设置主叫ID
mailboxes=101@default       ; 关联语音信箱
auth=101                      ; **关键**: 关联到名为 [101] 的 auth 配置
aors=101                      ; **关键**: 关联到名为 [101] 的 aor 配置

[101]                         ; Auth 配置 (注意这里没有模板)
type=auth
auth_type=userpass
password=password1            ; 设置用户 101 的密码
username=101                  ; 设置用户 101 的登录名

[101](aor_template)           ; 从模板继承，并定义 AOR


; --------------- 用户 102 (原 user2) ---------------
[102](endpoint_template)
callerid="用户2" <102>
mailboxes=102@default
auth=102
aors=102

[102]
type=auth
auth_type=userpass
password=password2
username=102

[102](aor_template)


; --------------- 技术支持 200 (原 support) ---------------
[200](endpoint_template)
callerid="技术支持" <200>
mailboxes=200@default
call_group=2                  ; 覆盖模板中的设置
pickup_group=2                ; 覆盖模板中的设置
allow=h264                    ; 为此用户额外开启 H.264 视频编码
videosupport=yes              ; 明确开启视频支持
auth=200
aors=200

[200]
type=auth
auth_type=userpass
password=support123
username=200

[200](aor_template)